
var SBTotal;(function(SBTotal){var bUseTotal=false;var isUseTotal=(function(){return bUseTotal;});var Convert=(function(){function Convert(convertInfo,orgGridJson,objColumnsInfo){bUseTotal=true;convertInfo.base.objColumnsInfo=_.clone(objColumnsInfo);if(convertInfo.base.isProgramSort)step_1_dataSort(convertInfo,orgGridJson);if(convertInfo.base.isDuplicationKey){step_2_duplicationGroup(convertInfo,orgGridJson);}else{step_2_uniqueGroup(convertInfo,orgGridJson);}
step_3_index_total_subtotal(convertInfo);step_4_insert_total_subtotal(convertInfo,orgGridJson);orgGridJson=convertInfo.base.data;};return Convert;})();SBTotal.Convert=Convert;SBTotal.isUseTotal=isUseTotal;function step_1_dataSort(convertInfo,orgGridJson){cmp=function(x,y){return x>y?1:x<y?-1:0;};var pivotSort=function(a,b){if(convertInfo.base.keyByRef.length==1){if(eval('a.'+convertInfo.base.keyByRef)==eval('b.'+convertInfo.base.keyByRef)){return 0;}
return eval('a.'+convertInfo.base.keyByRef)>eval('b.'+convertInfo.base.keyByRef)?1:-1;}else if(convertInfo.base.keyByRef.length==2){return cmp([cmp(eval('a.'+convertInfo.base.keyByRef[0]),eval('b.'+convertInfo.base.keyByRef[0])),cmp(eval('a.'+convertInfo.base.keyByRef[1]),eval('b.'+convertInfo.base.keyByRef[1]))],[cmp(eval('b.'+convertInfo.base.keyByRef[0]),eval('a.'+convertInfo.base.keyByRef[0])),cmp(eval('b.'+convertInfo.base.keyByRef[1]),eval('a.'+convertInfo.base.keyByRef[1]))]);}else if(convertInfo.base.keyByRef.length==3){return cmp([cmp(eval('a.'+convertInfo.base.keyByRef[0]),eval('b.'+convertInfo.base.keyByRef[0])),cmp(eval('a.'+convertInfo.base.keyByRef[1]),eval('b.'+convertInfo.base.keyByRef[1])),cmp(eval('a.'+convertInfo.base.keyByRef[2]),eval('b.'+convertInfo.base.keyByRef[2]))],[cmp(eval('b.'+convertInfo.base.keyByRef[0]),eval('a.'+convertInfo.base.keyByRef[0])),cmp(eval('b.'+convertInfo.base.keyByRef[1]),eval('a.'+convertInfo.base.keyByRef[1])),cmp(eval('b.'+convertInfo.base.keyByRef[2]),eval('a.'+convertInfo.base.keyByRef[2]))]);}else if(convertInfo.base.keyByRef.length==4){return cmp([cmp(eval('a.'+convertInfo.base.keyByRef[0]),eval('b.'+convertInfo.base.keyByRef[0])),cmp(eval('a.'+convertInfo.base.keyByRef[1]),eval('b.'+convertInfo.base.keyByRef[1])),cmp(eval('a.'+convertInfo.base.keyByRef[2]),eval('b.'+convertInfo.base.keyByRef[2])),cmp(eval('a.'+convertInfo.base.keyByRef[3]),eval('b.'+convertInfo.base.keyByRef[3]))],[cmp(eval('b.'+convertInfo.base.keyByRef[0]),eval('a.'+convertInfo.base.keyByRef[0])),cmp(eval('b.'+convertInfo.base.keyByRef[1]),eval('a.'+convertInfo.base.keyByRef[1])),cmp(eval('b.'+convertInfo.base.keyByRef[2]),eval('a.'+convertInfo.base.keyByRef[2])),cmp(eval('b.'+convertInfo.base.keyByRef[3]),eval('a.'+convertInfo.base.keyByRef[3]))]);}else if(convertInfo.base.keyByRef.length==5){return cmp([cmp(eval('a.'+convertInfo.base.keyByRef[0]),eval('b.'+convertInfo.base.keyByRef[0])),cmp(eval('a.'+convertInfo.base.keyByRef[1]),eval('b.'+convertInfo.base.keyByRef[1])),cmp(eval('a.'+convertInfo.base.keyByRef[2]),eval('b.'+convertInfo.base.keyByRef[2])),cmp(eval('a.'+convertInfo.base.keyByRef[3]),eval('b.'+convertInfo.base.keyByRef[3])),cmp(eval('a.'+convertInfo.base.keyByRef[4]),eval('b.'+convertInfo.base.keyByRef[4]))],[cmp(eval('b.'+convertInfo.base.keyByRef[0]),eval('a.'+convertInfo.base.keyByRef[0])),cmp(eval('b.'+convertInfo.base.keyByRef[1]),eval('a.'+convertInfo.base.keyByRef[1])),cmp(eval('b.'+convertInfo.base.keyByRef[2]),eval('a.'+convertInfo.base.keyByRef[2])),cmp(eval('b.'+convertInfo.base.keyByRef[3]),eval('a.'+convertInfo.base.keyByRef[3])),cmp(eval('b.'+convertInfo.base.keyByRef[4]),eval('a.'+convertInfo.base.keyByRef[4]))]);}else if(convertInfo.base.keyByRef.length==6){return cmp([cmp(eval('a.'+convertInfo.base.keyByRef[0]),eval('b.'+convertInfo.base.keyByRef[0])),cmp(eval('a.'+convertInfo.base.keyByRef[1]),eval('b.'+convertInfo.base.keyByRef[1])),cmp(eval('a.'+convertInfo.base.keyByRef[2]),eval('b.'+convertInfo.base.keyByRef[2])),cmp(eval('a.'+convertInfo.base.keyByRef[3]),eval('b.'+convertInfo.base.keyByRef[3])),cmp(eval('a.'+convertInfo.base.keyByRef[4]),eval('b.'+convertInfo.base.keyByRef[4])),cmp(eval('a.'+convertInfo.base.keyByRef[5]),eval('b.'+convertInfo.base.keyByRef[5]))],[cmp(eval('b.'+convertInfo.base.keyByRef[0]),eval('a.'+convertInfo.base.keyByRef[0])),cmp(eval('b.'+convertInfo.base.keyByRef[1]),eval('a.'+convertInfo.base.keyByRef[1])),cmp(eval('b.'+convertInfo.base.keyByRef[2]),eval('a.'+convertInfo.base.keyByRef[2])),cmp(eval('b.'+convertInfo.base.keyByRef[3]),eval('a.'+convertInfo.base.keyByRef[3])),cmp(eval('b.'+convertInfo.base.keyByRef[4]),eval('a.'+convertInfo.base.keyByRef[4])),cmp(eval('b.'+convertInfo.base.keyByRef[5]),eval('a.'+convertInfo.base.keyByRef[5]))]);}else if(convertInfo.base.keyByRef.length==7){return cmp([cmp(eval('a.'+convertInfo.base.keyByRef[0]),eval('b.'+convertInfo.base.keyByRef[0])),cmp(eval('a.'+convertInfo.base.keyByRef[1]),eval('b.'+convertInfo.base.keyByRef[1])),cmp(eval('a.'+convertInfo.base.keyByRef[2]),eval('b.'+convertInfo.base.keyByRef[2])),cmp(eval('a.'+convertInfo.base.keyByRef[3]),eval('b.'+convertInfo.base.keyByRef[3])),cmp(eval('a.'+convertInfo.base.keyByRef[4]),eval('b.'+convertInfo.base.keyByRef[4])),cmp(eval('a.'+convertInfo.base.keyByRef[5]),eval('b.'+convertInfo.base.keyByRef[5])),cmp(eval('a.'+convertInfo.base.keyByRef[6]),eval('b.'+convertInfo.base.keyByRef[6]))],[cmp(eval('b.'+convertInfo.base.keyByRef[0]),eval('a.'+convertInfo.base.keyByRef[0])),cmp(eval('b.'+convertInfo.base.keyByRef[1]),eval('a.'+convertInfo.base.keyByRef[1])),cmp(eval('b.'+convertInfo.base.keyByRef[2]),eval('a.'+convertInfo.base.keyByRef[2])),cmp(eval('b.'+convertInfo.base.keyByRef[3]),eval('a.'+convertInfo.base.keyByRef[3])),cmp(eval('b.'+convertInfo.base.keyByRef[4]),eval('a.'+convertInfo.base.keyByRef[4])),cmp(eval('b.'+convertInfo.base.keyByRef[5]),eval('a.'+convertInfo.base.keyByRef[5])),cmp(eval('b.'+convertInfo.base.keyByRef[6]),eval('a.'+convertInfo.base.keyByRef[6]))]);}};orgGridJson.sort(pivotSort);}
function step_2_duplicationGroup(convertInfo,orgGridJson){var groupRef=convertInfo.base.keyByRef;var arrTempGroupData=[];var arrGroupData=[];$.each(orgGridJson,function(gridIndex){arrGroupData.push(orgGridJson[gridIndex]);});convertInfo.base.data=arrGroupData;}
function step_2_uniqueGroup(convertInfo,orgGridJson){var groupRef=convertInfo.base.keyByRef;var arrTempGroupData=[];var arrGroupData=[];$.each(orgGridJson,function(gridIndex){var groupStr='';var tmpKey='';var tmpGropuStr='';$.each(groupRef,function(columnIndex){tmpKey=eval("orgGridJson["+gridIndex+"]."+groupRef[columnIndex]);tmpGropuStr+=',"'+groupRef[columnIndex]+'" : "'+tmpKey+'" ';});groupStr='{'+tmpGropuStr.substring(1)+'}';if(_.contains(arrTempGroupData,groupStr)==false){arrTempGroupData.push(groupStr);var groupStrData=_.where(orgGridJson,$.parseJSON(groupStr));if(_.size(groupStrData)>1){var sumGroupData='';$.each(groupStrData[0],function(innerDataIndex){if(_.contains(groupRef,innerDataIndex))return true;var innerDataGroup=_.pluck(groupStrData,innerDataIndex);var innerDataSum=_.reduce(_.compact(innerDataGroup),function(data1,data2){if(isNumber(data1)&&isNumber(data2)){return Number(data1)+Number(data2);}else{return data1+data2;}},'');sumGroupData+=',"'+innerDataIndex+'" : "'+innerDataSum+'" ';});sumGroupData='{'+tmpGropuStr.substring(1)+sumGroupData+'}';arrGroupData.push($.parseJSON(sumGroupData));}else{arrGroupData.push(orgGridJson[gridIndex]);}}});convertInfo.base.data=arrGroupData;}
function step_3_index_total_subtotal(convertInfo){var clonefixedPatternData=[];var collectionData={compare:{previousData:new Array(convertInfo.subTotal.length),currentData:new Array(convertInfo.subTotal.length)},text:{setupRefData:new Array(convertInfo.subTotal.length),otherRefData:new Array(convertInfo.subTotal.length)},temp:{level:{},title:{},otherLevel:{},addSubTotalOtherLevel:""}};$.each(convertInfo.base.data,function(dataIndex){if(dataIndex==0){if(!_.isUndefined(convertInfo.total)&&!_.isUndefined(convertInfo.total.top)){$.each(convertInfo.total.top,function(totalIndex){var addTotal=step_3_total(convertInfo,totalIndex,"top");if(addTotal.length>0){convertInfo.rowType.push($.parseJSON('{"type":"T" ,"position":"top" } '));clonefixedPatternData.push($.parseJSON(addTotal));}});}
if(!_.isUndefined(convertInfo.subTotal)){$.each(convertInfo.subTotal,function(subTotalIndex){step_3_subTotal_previous(convertInfo,collectionData,dataIndex,subTotalIndex);});}}else{if(!_.isUndefined(convertInfo.subTotal)){$.each(convertInfo.subTotal,function(subTotalIndex){step_3_subTotal_current(convertInfo,collectionData,dataIndex,subTotalIndex);if(_.isUndefined(convertInfo.subTotal[subTotalIndex].position)){convertInfo.subTotal[subTotalIndex].position="bottom";}
if(collectionData.compare.previousData[subTotalIndex]!=collectionData.compare.currentData[subTotalIndex]){var addSubTotalLevel=step_3_subTotal_makeJson(convertInfo,collectionData,subTotalIndex);if(addSubTotalLevel.length>0){var arrRowTypeLevel="";var arrRowTypeSubTotalLevel="";$.each(collectionData.temp.level,function(tmpIndex){if(tmpIndex>0)arrRowTypeLevel+=',"'+collectionData.temp.level[tmpIndex]+'"';arrRowTypeSubTotalLevel+=',"'+collectionData.temp.level[tmpIndex]+'"';});var arrRowType='{"type":"S", "subtotallevel": ';arrRowTypeLevel=arrRowType+'[ '+arrRowTypeLevel.substring(1)+']'+', "subtotalconfig": [ '+arrRowTypeSubTotalLevel.substring(1)+' ]'+', "position":"'+convertInfo.subTotal[subTotalIndex].position+'","uniqueGroup":"'+collectionData.compare.previousData[subTotalIndex]+'" }';convertInfo.rowType.push($.parseJSON(arrRowTypeLevel));clonefixedPatternData.push($.parseJSON(addSubTotalLevel));}
step_3_subTotal_previous(convertInfo,collectionData,dataIndex,subTotalIndex);}});}}
var arrRowGroupPrevious="";$.each(collectionData.compare.previousData,function(tmpIndex){arrRowGroupPrevious+=',"'+collectionData.compare.previousData[tmpIndex]+'"';});var arrRowGroup='{"type":"D" , "uniqueGroup" : ['+arrRowGroupPrevious.substring(1)+'] }';convertInfo.rowType.push($.parseJSON(arrRowGroup));clonefixedPatternData.push(convertInfo.base.data[dataIndex]);if(dataIndex==convertInfo.base.data.length-1){if(!_.isUndefined(convertInfo.subTotal)){$.each(convertInfo.subTotal,function(subTotalIndex){step_3_subTotal_current(convertInfo,collectionData,dataIndex,subTotalIndex);if(_.isUndefined(convertInfo.subTotal[subTotalIndex].position)){convertInfo.subTotal[subTotalIndex].position="bottom";}
var addSubTotalLevel=step_3_subTotal_makeJson(convertInfo,collectionData,subTotalIndex);if(addSubTotalLevel.length>0){var arrRowTypeLevel="";var arrRowTypeSubTotalLevel="";$.each(collectionData.temp.level,function(tmpIndex){if(tmpIndex>0)arrRowTypeLevel+=',"'+collectionData.temp.level[tmpIndex]+'"';arrRowTypeSubTotalLevel+=',"'+collectionData.temp.level[tmpIndex]+'"';});var arrRowType='{"type":"S", "subtotallevel": ';arrRowTypeLevel=arrRowType+'[ '+arrRowTypeLevel.substring(1)+']'+', "subtotalconfig": [ '+arrRowTypeSubTotalLevel.substring(1)+' ]'+', "position":"'+convertInfo.subTotal[subTotalIndex].position+'","uniqueGroup":"'+collectionData.compare.currentData[subTotalIndex]+'" }';convertInfo.rowType.push($.parseJSON(arrRowTypeLevel));clonefixedPatternData.push($.parseJSON(addSubTotalLevel));};});}
if(!_.isUndefined(convertInfo.total)&&!_.isUndefined(convertInfo.total.bottom)){$.each(convertInfo.total.bottom,function(totalIndex){var addTotal=step_3_total(convertInfo,totalIndex,"bottom");if(addTotal.length>0){convertInfo.rowType.push($.parseJSON('{"type":"T", "position":"bottom"  }'));clonefixedPatternData.push($.parseJSON(addTotal));};});}};});convertInfo.base.data=clonefixedPatternData;}
function step_3_total(convertInfo,totalIndex,rowLocation){var strTotalJson='';var strTotalTitle=[];if(rowLocation=="top"){if(convertInfo.total.top.length<=0)return strTotalJson;strTotalTitle=convertInfo.total.top[totalIndex].title;}else if(rowLocation=="bottom"){if(convertInfo.total.bottom.length<=0)return strTotalJson;strTotalTitle=convertInfo.total.bottom[totalIndex].title;}
$.each(convertInfo.base.keyByRef,function(levelIndex){if(_.isUndefined(strTotalTitle[levelIndex])){strTotalJson+=',"'+convertInfo.base.keyByRef[levelIndex]+'" : "" ';}else{strTotalJson+=',"'+convertInfo.base.keyByRef[levelIndex]+'" : "'+strTotalTitle[levelIndex]+'"';}});if(strTotalJson.length>0)strTotalJson='{'+strTotalJson.substring(1)+'}';return strTotalJson;}
function step_3_subTotal_previous(convertInfo,collectionData,dataIndex,subTotalIndex){collectionData.temp.level=convertInfo.subTotal[subTotalIndex].level;if(_.size(convertInfo.base.except)>0){collectionData.temp.otherLevel=_.omit(_.difference(convertInfo.base.keyByRef,collectionData.temp.level),convertInfo.base.except);}else{collectionData.temp.otherLevel=_.difference(convertInfo.base.keyByRef,collectionData.temp.level);}
collectionData.text.setupRefData[subTotalIndex]=eval("convertInfo.base.data[dataIndex]."+collectionData.temp.level[0]);collectionData.text.otherRefData[subTotalIndex]=new Array(collectionData.temp.otherLevel.length);$.each(collectionData.temp.otherLevel,function(levelIndex){collectionData.text.otherRefData[subTotalIndex][levelIndex]=eval("convertInfo.base.data[dataIndex]."+collectionData.temp.otherLevel[levelIndex]);collectionData.compare.previousData[subTotalIndex]=(levelIndex==0)?eval("convertInfo.base.data[dataIndex]."+collectionData.temp.otherLevel[levelIndex]):collectionData.compare.previousData[subTotalIndex]+eval("convertInfo.base.data[dataIndex]."+collectionData.temp.otherLevel[levelIndex]);});collectionData.compare.previousData[subTotalIndex]=(_.size(collectionData.temp.otherLevel)>0)?collectionData.compare.previousData[subTotalIndex]+eval("convertInfo.base.data[dataIndex]."+collectionData.temp.level[0]):eval("convertInfo.base.data[dataIndex]."+collectionData.temp.level[0]);}
function step_3_subTotal_current(convertInfo,collectionData,dataIndex,subTotalIndex){collectionData.temp.level=convertInfo.subTotal[subTotalIndex].level;collectionData.temp.title=convertInfo.subTotal[subTotalIndex].title;if(_.size(convertInfo.base.except)>0){collectionData.temp.otherLevel=_.omit(_.difference(convertInfo.base.keyByRef,collectionData.temp.level),convertInfo.base.except);}else{collectionData.temp.otherLevel=_.difference(convertInfo.base.keyByRef,collectionData.temp.level);}
collectionData.temp.addSubTotalOtherLevel='';$.each(collectionData.temp.otherLevel,function(levelIndex){if(isNumber(collectionData.text.otherRefData[subTotalIndex][levelIndex])){collectionData.temp.addSubTotalOtherLevel+='"'+eval("collectionData.temp.otherLevel[levelIndex]")+'" : '+collectionData.text.otherRefData[subTotalIndex][levelIndex]+', ';}else{collectionData.temp.addSubTotalOtherLevel+='"'+eval("collectionData.temp.otherLevel[levelIndex]")+'" : "'+collectionData.text.otherRefData[subTotalIndex][levelIndex]+'", ';}
collectionData.compare.currentData[subTotalIndex]=(levelIndex==0)?eval("convertInfo.base.data[dataIndex]."+collectionData.temp.otherLevel[levelIndex]):collectionData.compare.currentData[subTotalIndex]+eval("convertInfo.base.data[dataIndex]."+collectionData.temp.otherLevel[levelIndex]);});collectionData.compare.currentData[subTotalIndex]=(_.size(collectionData.temp.otherLevel)>0)?collectionData.compare.currentData[subTotalIndex]+eval("convertInfo.base.data[dataIndex]."+collectionData.temp.level[0]):eval("convertInfo.base.data[dataIndex]."+collectionData.temp.level[0]);}
function step_3_subTotal_makeJson(convertInfo,collectionData,subTotalIndex){var addSubTotalLevel='';var isBreakOnIncludeCheck=false;$.each(collectionData.temp.level,function(levelIndex){var subTotalKey=eval("collectionData.temp.level[levelIndex]");var subTotalValue=collectionData.temp.title[levelIndex];if(_.isUndefined(convertInfo.subTotal[subTotalIndex].includeData)==false){if(convertInfo.subTotal[subTotalIndex].includeData.length>0){if(convertInfo.subTotal[subTotalIndex].includeData[levelIndex].length>0){var includeText=convertInfo.subTotal[subTotalIndex].includeData[levelIndex];if(_.contains(includeText,collectionData.text.setupRefData[subTotalIndex])==false){isBreakOnIncludeCheck=true;addSubTotalLevel='';}}}}
if(_.isUndefined(convertInfo.subTotal[subTotalIndex].excludeData)==false){if(convertInfo.subTotal[subTotalIndex].excludeData.length>0){if(convertInfo.subTotal[subTotalIndex].excludeData[levelIndex].length>0){var excludeText=convertInfo.subTotal[subTotalIndex].excludeData[levelIndex];if(_.contains(excludeText,collectionData.text.setupRefData[subTotalIndex])){isBreakOnIncludeCheck=true;addSubTotalLevel='';}}}}
if(isBreakOnIncludeCheck)return false;if(subTotalValue.indexOf("*")!=-1){subTotalValue=subTotalValue.substring(0,subTotalValue.indexOf("*"))+collectionData.text.setupRefData[subTotalIndex]+subTotalValue.substring(subTotalValue.indexOf("*")+1);}
if(subTotalValue==(collectionData.text.setupRefData[subTotalIndex]+"")){addSubTotalLevel+=',"'+subTotalKey+'" : "'+subTotalValue+'" ';}else{addSubTotalLevel+=',"'+subTotalKey+'" : "'+subTotalValue+'" ';}});if(isBreakOnIncludeCheck==false)
addSubTotalLevel='{'+collectionData.temp.addSubTotalOtherLevel+addSubTotalLevel.substring(1)+'}';return addSubTotalLevel;}
function step_4_insert_total_subtotal(convertInfo,orgGridJson){var tmpTopRowType=[];var tmpCloneRowType=[];var tmpCloneData=[];var tmpTopData=[];$.each(convertInfo.rowType,function(rowIndex){if(_.values(convertInfo.rowType[rowIndex])[0]=="S"){if(convertInfo.rowType[rowIndex].position=="top"){tmpTopRowType.push(convertInfo.rowType[rowIndex]);tmpTopData.push(convertInfo.base.data[rowIndex]);return true;}}
tmpCloneRowType.push(convertInfo.rowType[rowIndex]);tmpCloneData.push(convertInfo.base.data[rowIndex]);});$.each(tmpTopRowType,function(topRowIndex){$.each(tmpCloneRowType,function(rowIndex){if(_.values(tmpCloneRowType[rowIndex])[0]=="D"){if(_.contains(tmpCloneRowType[rowIndex].uniqueGroup,tmpTopRowType[topRowIndex].uniqueGroup)){tmpCloneRowType.splice(rowIndex,0,tmpTopRowType[topRowIndex]);tmpCloneData.splice(rowIndex,0,tmpTopData[topRowIndex]);return false;}}});});convertInfo.rowType=tmpCloneRowType;convertInfo.base.data=tmpCloneData;$.each(convertInfo.rowType,function(rowIndex){switch(_.values(convertInfo.rowType[rowIndex])[0]){case"D":step_4_1_apply_data_datacolumn(convertInfo,rowIndex);break;case"S":step_4_2_apply_subtotal(convertInfo,rowIndex,orgGridJson);break;case"T":step_4_2_apply_total(convertInfo,rowIndex,orgGridJson);break;}});}
function step_4_1_apply_data_datacolumn(convertInfo,rowIndex){var rowJson=_.clone(convertInfo.base.data[rowIndex]);$.each(rowJson,function(headerIndex){if(_.contains(convertInfo.base.keyByRef,headerIndex))return true;var data=rowJson[headerIndex]+"";if(_.isUndefined(data)==false){if(_.isEmpty(data)){rowJson[headerIndex]=convertInfo.base.emptyDataReplace;}else{if(isNumber(data)){if(_.isString(data))data=Number(data);if(_.isUndefined(convertInfo.base.isConvertInteger)==false){if(convertInfo.base.isConvertInteger){rowJson[headerIndex]=data.toFixed(convertInfo.base.digit);}else{var strData=data+"";if(strData.indexOf('.')>-1){rowJson[headerIndex]=data.toFixed(convertInfo.base.digit);}else{rowJson[headerIndex]=data;}}}else{rowJson[headerIndex]=data.toFixed(convertInfo.base.digit);}}}}else{rowJson[headerIndex]=convertInfo.base.emptyDataReplace;}});convertInfo.base.data[rowIndex]=rowJson;}
function step_4_2_apply_subtotal(convertInfo,rowIndex,orgGridJson){var rowJson;var valueJson;if(_.isEmpty(convertInfo.rowType[rowIndex].subtotallevel)){rowJson=_.clone(convertInfo.base.data[rowIndex]);valueJson=_.where(orgGridJson,_.object(_.keys(rowJson),[convertInfo.rowType[rowIndex].uniqueGroup]));}else{rowJson=_.clone(convertInfo.base.data[rowIndex]);valueJson=_.where(orgGridJson,_.omit(rowJson,convertInfo.rowType[rowIndex].subtotallevel));}
$.each(convertInfo.subTotal,function(subTotalIndex){if(_.isEqual(convertInfo.subTotal[subTotalIndex].level,convertInfo.rowType[rowIndex].subtotalconfig)){$.each(convertInfo.subTotal[subTotalIndex].valueByRef,function(refColumnIndex){var refDataGroup=[];var subtotalKey=convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].ref;var subtotalValue=0;var direction="column";if(_.isUndefined(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].direction)==false){direction=convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].direction;}
if(direction=="column"){if(_.isUndefined(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].isMergeCellOneData)==false){if(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].isMergeCellOneData){var tmpArrGroups=[];var mergeKeys=convertInfo.rowType[rowIndex].subtotalconfig.concat(subtotalKey);$.each(valueJson,function(valuJsonIndex){if(_.size(_.where(tmpArrGroups,_.pick(valueJson[valuJsonIndex],mergeKeys)))==0){tmpArrGroups.push(_.pick(valueJson[valuJsonIndex],mergeKeys));}});refDataGroup.push(_.pluck(tmpArrGroups,subtotalKey));}else{refDataGroup.push(_.pluck(valueJson,subtotalKey));}}else{refDataGroup.push(_.pluck(valueJson,subtotalKey));}}else{}
if(direction=="column"){if(_.isUndefined(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].fixedCalc)==false){var fiexedCalc=convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].fixedCalc;if(fiexedCalc=="sum"||fiexedCalc=="average"){subtotalValue=_.reduce(_.compact(refDataGroup[0]),function(memo,num){return Number(memo)+Number(num);},0);if(fiexedCalc=="average"){subtotalValue=subtotalValue/_.compact(refDataGroup[0]).length;}}else if(fiexedCalc=="max"){subtotalValue=_.reduce(_.compact(refDataGroup[0]),function(memo,num){return Number(memo)>Number(num)?Number(memo):Number(num);},0);}else if(fiexedCalc=="min"){if(_.isUndefined(refDataGroup[0][0])==false)
subtotalValue=_.reduce(_.compact(refDataGroup[0]),function(memo,num){return Number(memo)>Number(num)?Number(num):Number(memo);},refDataGroup[0][0]);else
subtotalValue=_.reduce(_.compact(refDataGroup[0]),function(memo,num){return Number(memo)>Number(num)?Number(num):Number(memo);},0);}else if(fiexedCalc=="count"){subtotalValue=_.compact(refDataGroup[0]).length;}}
if(_.isUndefined(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].userCalc)==false){var keyCollection={groupData:[],totalData:[]};var isUsingMergeRef=_.isUndefined(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].mergeRef);if(_.isUndefined(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].groupRef)==false){$.each(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].groupRef,function(groupRefIndex){var groupRefKeys=convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].groupRef[groupRefIndex];if(isUsingMergeRef==false){if(_.contains(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].mergeRef,groupRefKeys)){var tmpArrGroups=[];var mergeKeys=convertInfo.rowType[rowIndex].subtotalconfig.concat(groupRefKeys);$.each(valueJson,function(valuJsonIndex){if(_.size(_.where(tmpArrGroups,_.pick(valueJson[valuJsonIndex],mergeKeys)))==0){tmpArrGroups.push(_.pick(valueJson[valuJsonIndex],mergeKeys));}});keyCollection.groupData.push(_.pluck(tmpArrGroups,groupRefKeys));}else{keyCollection.groupData.push(_.pluck(valueJson,groupRefKeys));}}else{keyCollection.groupData.push(_.pluck(valueJson,groupRefKeys));}});}
if(_.isUndefined(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].totalRef)==false){$.each(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].totalRef,function(totalRefIndex){var totalRefKeys=convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].totalRef[totalRefIndex];if(isUsingMergeRef==false){if(_.contains(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].mergeRef,totalRefKeys)){var tmpArrGroups=[];var mergeKeys=convertInfo.rowType[rowIndex].subtotalconfig.concat(totalRefKeys);$.each(orgGridJson,function(valuJsonIndex){if(_.size(_.where(tmpArrGroups,_.pick(orgGridJson[valuJsonIndex],mergeKeys)))==0){tmpArrGroups.push(_.pick(orgGridJson[valuJsonIndex],mergeKeys));}});keyCollection.totalData.push(_.pluck(tmpArrGroups,totalRefKeys));}else{keyCollection.totalData.push(_.pluck(orgGridJson,totalRefKeys));}}else{keyCollection.totalData.push(_.pluck(orgGridJson,totalRefKeys));}});}
subtotalValue=eval(convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].userCalc+"(keyCollection.groupData,keyCollection.totalData)");subtotalKey=convertInfo.subTotal[subTotalIndex].valueByRef[refColumnIndex].position;}
var valueData="";if(_.isUndefined(convertInfo.base.isConvertInteger)==false){if(convertInfo.base.isConvertInteger){valueData='{"'+subtotalKey+'" : "'+subtotalValue.toFixed(convertInfo.base.digit)+'"}';}else{var strSum=subtotalValue+"";if(strSum.indexOf('.')>-1){valueData='{"'+subtotalKey+'" : "'+subtotalValue.toFixed(convertInfo.base.digit)+'"}';}else{valueData='{"'+subtotalKey+'" : "'+subtotalValue+'"}';}}}else{valueData='{"'+subtotalKey+'" : "'+subtotalValue.toFixed(convertInfo.base.digit)+'"}';}
if(_.isEmpty(valueData)==false)_.extend(rowJson,$.parseJSON(valueData));}else{}});return false;}});convertInfo.base.data[rowIndex]=rowJson;}
function step_4_2_apply_total(convertInfo,rowIndex,orgGridJson){var rowJson=_.clone(convertInfo.base.data[rowIndex]);var tmpTotalTopBottom=[];if(convertInfo.rowType[rowIndex].position=="top"){tmpTotalTopBottom=convertInfo.total.top;}else if(convertInfo.rowType[rowIndex].position=="bottom"){tmpTotalTopBottom=convertInfo.total.bottom;}
if(_.isUndefined(tmpTotalTopBottom)==false){$.each(tmpTotalTopBottom,function(topBottomIndex){if(_.isUndefined(tmpTotalTopBottom[topBottomIndex].isBinded)==false)return true;$.each(tmpTotalTopBottom[topBottomIndex].valueByRef,function(refColumnIndex){var refDataGroup=[];var totalKey=tmpTotalTopBottom[topBottomIndex].valueByRef[refColumnIndex].ref;var totalValue=0;if(_.isUndefined(tmpTotalTopBottom[topBottomIndex].valueByRef[refColumnIndex].isMergeCellOneData)==false){if(tmpTotalTopBottom[topBottomIndex].valueByRef[refColumnIndex].isMergeCellOneData){var tmpArrGroups=[];var mergeKeys=convertInfo.base.keyByRef.concat(totalKey);$.each(orgGridJson,function(valuJsonIndex){if(_.size(_.where(tmpArrGroups,_.pick(orgGridJson[valuJsonIndex],mergeKeys)))==0){tmpArrGroups.push(_.pick(orgGridJson[valuJsonIndex],mergeKeys));}});refDataGroup.push(_.pluck(tmpArrGroups,totalKey));}else{refDataGroup.push(_.pluck(orgGridJson,totalKey));}}else{refDataGroup.push(_.pluck(orgGridJson,totalKey));}
if(_.isUndefined(tmpTotalTopBottom[topBottomIndex].valueByRef[refColumnIndex].fixedCalc)==false){var fiexedCalc=tmpTotalTopBottom[topBottomIndex].valueByRef[refColumnIndex].fixedCalc;if(fiexedCalc=="sum"||fiexedCalc=="average"){totalValue=_.reduce(_.compact(refDataGroup[0]),function(memo,num){return Number(memo)+Number(num);},0);if(fiexedCalc=="average"){totalValue=totalValue/_.compact(refDataGroup[0]).length;}}else if(fiexedCalc=="max"){totalValue=_.reduce(_.compact(refDataGroup[0]),function(memo,num){return Number(memo)>Number(num)?Number(memo):Number(num);},0);}else if(fiexedCalc=="min"){if(_.isUndefined(refDataGroup[0][0])==false)
totalValue=_.reduce(_.compact(refDataGroup[0]),function(memo,num){return Number(memo)>Number(num)?Number(num):Number(memo);},refDataGroup[0][0]);else
totalValue=_.reduce(_.compact(refDataGroup[0]),function(memo,num){return Number(memo)>Number(num)?Number(num):Number(memo);},0);}else if(fiexedCalc=="count"){totalValue=_.compact(refDataGroup[0]).length;}}
var valueData="";if(_.isUndefined(convertInfo.base.isConvertInteger)==false){if(convertInfo.base.isConvertInteger){valueData='{"'+totalKey+'" : "'+totalValue.toFixed(convertInfo.base.digit)+'"}';}else{var strSum=totalValue+"";if(strSum.indexOf('.')>-1){valueData='{"'+totalKey+'" : "'+totalValue.toFixed(convertInfo.base.digit)+'"}';}else{valueData='{"'+totalKey+'" : "'+totalValue+'"}';}}}else{valueData='{"'+totalKey+'" : "'+totalValue.toFixed(convertInfo.base.digit)+'"}';}
if(_.isEmpty(valueData)==false)_.extend(rowJson,$.parseJSON(valueData));});_.extend(tmpTotalTopBottom[topBottomIndex],$.parseJSON(' {"isBinded":"y"} '));return false;});}
convertInfo.base.data[rowIndex]=rowJson;}
function isNumber(str){var pattern=/^\d+$/;return pattern.test(str);}})(SBTotal||(SBTotal={}));